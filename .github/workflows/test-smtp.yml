# .github/workflows/test-smtp.yml

name: Test SMTP Connection

on:
  workflow_dispatch: # 只允许手动触发

jobs:
  run-smtp-test:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Network / TLS connectivity checks
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
        run: |
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends netcat-openbsd openssl
          echo "Testing TCP connect to $SMTP_SERVER:$SMTP_PORT"
          nc -vz $SMTP_SERVER $SMTP_PORT || true
          if [ "$SMTP_PORT" = "465" ]; then
            echo "Testing SMTPS TLS handshake for port 465"
            echo | openssl s_client -connect $SMTP_SERVER:465 -brief -crlf || true
          else
            echo "Testing STARTTLS (if supported) for port $SMTP_PORT"
            echo | openssl s_client -connect $SMTP_SERVER:$SMTP_PORT -starttls smtp -brief -crlf || true
          fi

      - name: Run SMTP Test Script
        env:
          # 我们只需要发送邮件的凭据
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          SENDER_AUTH_CODE: ${{ secrets.SENDER_AUTH_CODE }}
          RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL }}
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
        run: |
          python - <<'EOF'
          import os, smtplib, sys, traceback
          from email.mime.text import MIMEText
          from datetime import datetime

          # 从环境变量获取配置
          SENDER_EMAIL = os.environ.get('SENDER_EMAIL')
          SENDER_AUTH_CODE = os.environ.get('SENDER_AUTH_CODE')
          RECEIVER_EMAIL = os.environ.get('RECEIVER_EMAIL')
          SMTP_SERVER = os.environ.get('SMTP_SERVER')
          SMTP_PORT = int(os.environ.get('SMTP_PORT', '587'))

          print('--- 开始SMTP连接测试 ---')
          print(f'服务器: {SMTP_SERVER}, 端口: {SMTP_PORT}')
          print(f'发件人: {SENDER_EMAIL}')

          message = MIMEText('这是一封来自GitHub Actions的SMTP连接测试邮件。', 'plain', 'utf-8')
          message['From'] = SENDER_EMAIL
          message['To'] = RECEIVER_EMAIL
          message['Subject'] = f'SMTP Test from GitHub Actions - {datetime.now().strftime("%H:%M:%S")}'

          try:
              timeout = 60
              if SMTP_PORT == 465:
                  print('使用 SMTP_SSL (隐式 TLS) 连接到端口 465')
                  server = smtplib.SMTP_SSL(SMTP_SERVER, SMTP_PORT, timeout=timeout)
                  server.set_debuglevel(1)
                  server.ehlo()
              else:
                  print('使用 SMTP + STARTTLS 连接')
                  server = smtplib.SMTP(SMTP_SERVER, SMTP_PORT, timeout=timeout)
                  server.set_debuglevel(1)
                  server.ehlo()
                  server.starttls()
                  server.ehlo()

              print('\n[步骤: 登录]')
              server.login(SENDER_EMAIL, SENDER_AUTH_CODE)

              print('\n[步骤: 发送邮件]')
              server.sendmail(SENDER_EMAIL, [RECEIVER_EMAIL], message.as_string())

              print('\n[步骤: 关闭连接]')
              server.quit()
              print('\n✅ SMTP连接测试成功！')

          except Exception as e:
              print(f'❌ SMTP连接测试失败: {type(e).__name__}: {e}')
              traceback.print_exc()
              sys.exit(1)
          EOF
